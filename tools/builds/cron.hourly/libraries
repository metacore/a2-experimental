#!/bin/sh

directory="/var/tmp/libraries/"
update () { svn checkout --non-interactive --quiet https://svn-dept.inf.ethz.ch/svn/lecturers/a2/trunk/tools/builds/a2 "$directory" && svn checkout --non-interactive --quiet --trust-server-cert-failures unknown-ca,expired https://www.ocp.inf.ethz.ch/svn/ocp/trunk/Matrix "$directory/source/Matrix" && (cd "$directory" && svn patch --quiet source/Matrix/libraries.patch) && make --directory "$directory" --quiet dependencies && version="$(svnversion "$directory/source/Matrix").$(svnversion "$directory/source")"; }
check () { make --question --directory "$directory" --quiet "$target"; }
build () { timeout 1h make --directory "$directory" --quiet "$target"; }
notify () { echo "$output" | sendbuild "Libraries" "$target" "$version" "$status"; }

update || exit 1

process ()
{
	local target="$1"
	check && exit 0
	local status="Building" output=""
	notify
	trap notify exit
	trap "status=Aborted" int term kill
	status="Failed" output=$(build 2>&1)
	test $? -eq 0 && status="Succeeded" output=""
	trap exit
	notify
}

process "Matrix Library"
